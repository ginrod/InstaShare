name: Build and Push InstaShare.API to ACR

on:
  push:
    paths:
      - 'InstaShare.API/**'
      - '.github/workflows/deploy-api.yaml'

env:
  IMAGE_NAME: instashare-api

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMG_NAME_SVC: instashare-api

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build \
          -f ./InstaShare.API/InstaShare.API/Dockerfile \
          -t ${{secrets.INSTA_SHARE_ACR_HOST}}/${IMG_NAME_SVC}:latest \
          -t ${{secrets.INSTA_SHARE_ACR_HOST}}/${IMG_NAME_SVC}:${GITHUB_SHA::8} \
          .

      - name: Discord Notification (build)
        uses: Ilshidur/action-discord@master
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          message: |
            üì¶ *Build docker image* finished with status: **${{ job.status }}**
            üß± Job: `${{ github.job }}`
            üîÅ Branch: `${{ github.ref_name }}`
            üîó Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Log in to ACR
        uses: docker/login-action@v1
        if: github.ref == 'refs/heads/main'
        with:
          registry: ${{ secrets.INSTA_SHARE_ACR_HOST }}
          username: ${{ secrets.INSTA_SHARE_ACR_USER }}
          password: ${{ secrets.INSTA_SHARE_ACR_PASSWORD }}

      - name: Push images to ACR
        if: github.ref == 'refs/heads/main'
        run: |
          docker push ${{secrets.INSTA_SHARE_ACR_HOST}}/${IMG_NAME_SVC}
          docker push ${{secrets.INSTA_SHARE_ACR_HOST}}/${IMG_NAME_SVC}:${GITHUB_SHA::8}

      - name: Discord Notification (publish)
        uses: Ilshidur/action-discord@master
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          message: |
            üì¶ *Push docker image* finished with status: **${{ job.status }}**
            üß± Job: `${{ github.job }}`
            üîÅ Branch: `${{ github.ref_name }}`
            üîó Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
